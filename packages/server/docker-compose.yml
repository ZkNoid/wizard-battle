services:
  mongodb:
    image: mongo:latest
    container_name: mongodb
    ports:
      - '27017:27017'
    volumes:
      - mongodb_data:/data/db
    environment:
      - MONGO_INITDB_ROOT_USERNAME=${MONGO_USERNAME}
      - MONGO_INITDB_ROOT_PASSWORD=${MONGO_PASSWORD}
    networks:
      - bridge

  # postgres:
  #   image: postgres:16-alpine
  #   container_name: orbitrium-postgres
  #   environment:
  #     POSTGRES_USER: ${POSTGRES_USER}
  #     POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
  #     POSTGRES_DB: ${POSTGRES_DB}
  #   ports:
  #     - '5432:5432'
  #   volumes:
  #     - postgres_data:/var/lib/postgresql/data
  #   healthcheck:
  #     test: ['CMD-SHELL', 'pg_isready -U ${POSTGRES_USER} -d ${POSTGRES_DB}']
  #     interval: 10s
  #     timeout: 5s
  #     retries: 5
  #     start_period: 10s
  #   networks:
  #     - orbitrium_net
  #   restart: unless-stopped

  # # Daily backup container
  # postgres-backup:
  #   image: postgres:16-alpine
  #   container_name: orbitrium-postgres-backup
  #   environment:
  #     PGHOST: postgres # connects to the postgres service above
  #     PGUSER: ${POSTGRES_USER}
  #     PGPASSWORD: ${POSTGRES_PASSWORD}
  #     PGDATABASE: ${POSTGRES_DB}
  #     BACKUP_DIR: /backups
  #     BACKUP_KEEP_DAYS: 7 # keep last 7 daily backups
  #   volumes:
  #     - ./backups:/backups # host folder where backups will be stored
  #   command: |
  #     sh -c '
  #       # Install only what we really need
  #       apk add --no-cache bash dcron curl

  #       # Make sure the script from the host is executable
  #       if [ ! -f /backups/backup.sh ]; then
  #         echo "ERROR: /backups/backup.sh not found on host!" >&2
  #         exit 1
  #       fi
  #       chmod +x /backups/backup.sh

  #       # Schedule it (minute hour day month weekday)
  #       echo "0 3 * * * /backups/backup.sh >> /var/log/backup.log 2>&1" > /etc/crontabs/root

  #       # Create log file so tail works immediately
  #       touch /var/log/backup.log

  #       echo "Backup scheduler started - will run /backups/backup.sh daily at 03:00 UTC"
  #       crond -f -L /dev/stdout
  #     '
  #   depends_on:
  #     postgres:
  #       condition: service_healthy
  #   networks:
  #     - orbitrium_net
  #   restart: unless-stopped

  nestjs-main:
    image: nestjs-main:latest
    container_name: nestjs-main
    #    ports:
    #      - "3030:3030"
    volumes:
      - data:/usr/share/temp
    networks:
      - bridge

  nestjs-dev:
    image: nestjs-dev:latest
    container_name: nestjs-dev
    #    ports:
    #      - "3031:3031"
    volumes:
      - data:/usr/share/temp
    networks:
      - bridge

  nginx:
    image: nginx:latest
    container_name: nginx
    ports:
      - '80:80'
      - '443:443'
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/ssl:/etc/nginx/ssl:ro
    networks:
      - bridge

  redis:
    image: redis:latest
    container_name: redis-server
    restart: unless-stopped
    #    ports:
    #      - "6379:6379"
    volumes:
      - ./redis/redis-data:/data
      - ./redis/redis.conf:/usr/local/etc/redis/redis.conf
    command: redis-server /usr/local/etc/redis/redis.conf --appendonly yes
    networks:
      - bridge

  # redis-orbirium:
  #   image: redis:latest
  #   container_name: redis-orbirium
  #   environment:
  #     - REDIS_PASSWORD=${REDIS_PASSWORD}
  #   ports:
  #     - '6378:6379'
  #   volumes:
  #     - ./redis-orbirium/redis-data:/data
  #     - ./redis-orbirium/redis.conf:/usr/local/etc/redis/redis.conf
  #   command: redis-server /usr/local/etc/redis/redis.conf --appendonly yes --requirepass ${REDIS_PASSWORD}
  #   networks:
  #     - orbitrium_net

volumes:
  mongodb_data:
  data:
  postgres_data:

networks:
  bridge:
    driver: bridge
  orbitrium_net:
    driver: bridge
