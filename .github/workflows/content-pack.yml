name: Context Pack (Repo Map)

on:
  issues:
    types: [labeled]  # run when a label is added :contentReference[oaicite:3]{index=3}

permissions:
  contents: read     # read repo files
  issues: write      # post a comment :contentReference[oaicite:4]{index=4}

jobs:
  context_pack:
    # Run only for specific labels (so you don't spam every issue)
    if: github.event.label.name == 'agent-ok' || github.event.label.name == 'agent-feature'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4 :contentReference[oaicite:5]{index=5}

      - name: Generate repo map
        shell: bash
        run: |
          set -euo pipefail

          echo "# Context Pack" > context_pack.md
          echo "" >> context_pack.md
          echo "## Repo map (top-level, depth 4)" >> context_pack.md
          echo "" >> context_pack.md

          # Prefer tree; fallback to find if tree is unavailable
          if command -v tree >/dev/null 2>&1; then
            tree -L 4 \
              -I 'node_modules|.git|.next|dist|build|coverage' \
              >> context_pack.md
          else
            find . -maxdepth 4 -type f \
              ! -path '*/.git/*' \
              ! -path '*/node_modules/*' \
              ! -path '*/.next/*' \
              ! -path '*/dist/*' \
              ! -path '*/build/*' \
              ! -path '*/coverage/*' \
              | sed 's|^\./||' \
              | sort \
              | head -n 400 \
              >> context_pack.md
          fi

          echo "" >> context_pack.md
          echo "## Key files" >> context_pack.md
          echo "" >> context_pack.md
          (ls -la package.json pnpm-lock.yaml yarn.lock package-lock.json next.config.* tsconfig.json 2>/dev/null || true) >> context_pack.md

          # Keep comment reasonably sized
          head -n 600 context_pack.md > context_pack_trimmed.md
          mv context_pack_trimmed.md context_pack.md

      - name: Post context pack as issue comment
        uses: actions/github-script@v7 :contentReference[oaicite:6]{index=6}
        with:
          script: |
            const fs = require('fs');
            const body = fs.readFileSync('context_pack.md', 'utf8');

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.issue.number,
              body
            });
