name: Context Pack (Repo Map)

on:
  issues:
    types: [labeled]

permissions:
  contents: read
  issues: write

jobs:
  context_pack:
    if: github.event.label.name == 'agent-bug' || github.event.label.name == 'agent-feature'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Generate repo map
        shell: bash
        run: |
          set -euo pipefail

          echo "# Context Pack" > context_pack.md
          echo "" >> context_pack.md
          echo "## Repo map (depth 4)" >> context_pack.md
          echo "" >> context_pack.md

          if command -v tree >/dev/null 2>&1; then
            tree -L 4 -I 'node_modules|.git|.next|dist|build|coverage' >> context_pack.md
          else
            find . -maxdepth 4 -type f \
              ! -path '*/.git/*' \
              ! -path '*/node_modules/*' \
              ! -path '*/.next/*' \
              ! -path '*/dist/*' \
              ! -path '*/build/*' \
              ! -path '*/coverage/*' \
              | sed 's|^\./||' \
              | sort \
              | head -n 400 \
              >> context_pack.md
          fi

          echo "" >> context_pack.md
          echo "## Key files" >> context_pack.md
          echo "" >> context_pack.md
          (ls -la package.json pnpm-lock.yaml yarn.lock package-lock.json next.config.* tsconfig.json 2>/dev/null || true) >> context_pack.md

          # Keep the comment reasonably sized
          head -n 600 context_pack.md > context_pack_trimmed.md
          mv context_pack_trimmed.md context_pack.md

      - name: Post context pack as issue comment
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const body = fs.readFileSync('context_pack.md', 'utf8');

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.issue.number,
              body
            });
