name: Build & Deploy Docker Image

on:
  push:
    branches:
      - main
      - dev

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Trigger Vercel Deploy Hook
        env:
          DEPLOY_HOOKS: '{"main": "https://api.vercel.com/v1/integrations/deploy/prj_C1HUgN5FZYWAVc6rLyg0su57Miui/Mr2uYTmBav", "dev": "https://api.vercel.com/v1/integrations/deploy/prj_C1HUgN5FZYWAVc6rLyg0su57Miui/eVHIfTAoWi"}'
          TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          COMMIT_MESSAGE: ${{ github.event.head_commit.message }}
        run: |
          BRANCH=${{ github.ref_name }}
          HOOK_URL=$(echo "$DEPLOY_HOOKS" | jq -r ".[\"$BRANCH\"]")
          if [ -n "$HOOK_URL" ]; then
            curl -X POST "$HOOK_URL"
            echo "Triggered deployment for $BRANCH"
            if [ -z "$TELEGRAM_TOKEN" ]; then
              echo "Error: TELEGRAM_TOKEN is empty"
            else
              echo "TELEGRAM_TOKEN is set (length: ${#TELEGRAM_TOKEN})"
            fi
            ESCAPED_COMMIT_MESSAGE=$(echo "$COMMIT_MESSAGE" | sed 's/"/\\"/g; s/\\/\\\\/g; s/&/%26/g; s/=/\\=/g')
            RESPONSE=$(curl -s -X POST "https://api.telegram.org/bot$TELEGRAM_TOKEN/sendMessage" -d chat_id=$TELEGRAM_CHAT_ID -d text="New power has awakened in the $BRANCH land. Be aware: $ESCAPED_COMMIT_MESSAGE")
            echo "Telegram API response: $RESPONSE"
            echo "Triggered telegram message for $BRANCH"
          else
            echo "No Deploy Hook configured for $BRANCH"
          fi

  copy-redis-config:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Install ssh client
        run: sudo apt-get update && sudo apt-get install -y openssh-client

      - name: Copy redis.conf to remote server via SCP
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          port: ${{ secrets.SERVER_PORT }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          source: 'packages/redis/redis.conf'
          target: ${{ secrets.TARGET_PATH }}
          strip_components: 1

  copy-nginx-config:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Install ssh client
        run: sudo apt-get update && sudo apt-get install -y openssh-client

      - name: Copy nginx.conf to remote server via SCP
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          port: ${{ secrets.SERVER_PORT }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          source: 'packages/nginx/nginx.conf'
          target: ${{ secrets.TARGET_PATH }}
          strip_components: 1

  copy-server-config:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Install ssh client
        run: sudo apt-get update && sudo apt-get install -y openssh-client

      - name: Copy docker-compose.yml to remote server via SCP
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          port: ${{ secrets.SERVER_PORT }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          source: 'packages/server/docker-compose.yml'
          target: ${{ secrets.TARGET_PATH }}
          strip_components: 2

  build-and-deploy:
    runs-on: ubuntu-latest
    env:
      DEPLOY_CONTAINER: '{"main": "nestjs-main", "dev": "nestjs-dev"}'
      APP_PORT: '{"main": "3030", "dev": "3031"}'
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Docker
        uses: docker/setup-buildx-action@v3

      - name: Log in to Docker (opt
        run: echo "Skipping Docker Hub login if not pushing to registry."

      - name: Calculate deploy container name
        id: calc-container
        run: |
          BRANCH=${{ github.ref_name }}
          DEPLOY_CONTAINER=$(echo "$DEPLOY_CONTAINER" | jq -r ".[\"$BRANCH\"]")
          echo "container_name=$DEPLOY_CONTAINER" >> $GITHUB_OUTPUT
          APP_PORT=$(echo "$APP_PORT" | jq -r ".[\"$BRANCH\"]")
          echo "app_port=$APP_PORT" >> $GITHUB_OUTPUT

      - name: Build Docker image
        run: |
          docker build \
            --build-arg MONGODB_URI=${{ secrets.MONGODB_URI }} \
            --build-arg MONGODB_DB=${{ secrets.MONGODB_DB }} \
            --build-arg APP_PORT=${{ steps.calc-container.outputs.app_port }} \
            --build-arg REDIS_URL=${{ secrets.REDIS_URL }} \
            --build-arg WEBSOCKET_URL=${{ secrets.WEBSOCKET_URL }} \
            --build-arg SPELL_CAST_TIMEOUT=${{ secrets.SPELL_CAST_TIMEOUT }} \
            -t ${{ steps.calc-container.outputs.container_name }} .

      - name: Save Docker image to tar
        run: |
          docker save ${{ steps.calc-container.outputs.container_name }} -o ${{ steps.calc-container.outputs.container_name }}.tar
          chmod 644 ${{ steps.calc-container.outputs.container_name }}.tar

      - name: Install ssh client
        run: sudo apt-get update && sudo apt-get install -y openssh-client

      - name: Copy image to remote server via SCP
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          port: ${{ secrets.SERVER_PORT }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          source: '${{ steps.calc-container.outputs.container_name }}.tar'
          target: ${{ secrets.TARGET_PATH }}

      - name: SSH into server, regenerate .env and deploy
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          port: ${{ secrets.SERVER_PORT }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          script: |
            cat > .env << EOF
              MONGO_USERNAME=${{ secrets.MONGO_USERNAME }}
              MONGO_PASSWORD=${{ secrets.MONGO_PASSWORD }}
              POSTGRES_USER=${{ secrets.POSTGRES_USER }}
              POSTGRES_PASSWORD=${{ secrets.POSTGRES_PASSWORD }}
              POSTGRES_DB=${{ secrets.POSTGRES_DB }}
              # Add any other variables you need here, e.g.:
              # SOME_API_KEY=${{ secrets.SOME_API_KEY }}
              EOF

              # Optional: set correct permissions (paranoid mode)
              chmod 600 .env

              # Clean up old unused images/containers
              docker system prune -f

              # Load the new image you just pushed/scp'd
              docker load -i ${{ steps.calc-container.outputs.container_name }}.tar

              # Gracefully stop & remove old container (idempotent)
              docker stop ${{ steps.calc-container.outputs.container_name }} || true
              docker rm ${{ steps.calc-container.outputs.container_name }} || true

              # Bring up the stack with the fresh .env
              docker compose up -d
